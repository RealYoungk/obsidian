---
tags:
  - 대시보드
  - 주가
---

# 📊 주가 대시보드

## 🔄 최신 스냅샷

```dataview
TABLE WITHOUT ID
  file.link AS "스냅샷",
  created AS "생성시각"
FROM "0. 대시보드/주가스냅샷"
WHERE type = "stock-snapshot"
SORT created DESC
LIMIT 1
```

## 📈 전체 기업 현황

```dataviewjs
// 최신 스냅샷 파일 찾기
const snapshots = dv.pages('"0. 대시보드/주가스냅샷"')
    .where(p => p.type === "stock-snapshot")
    .sort(p => p.created, 'desc');

const latestSnapshot = snapshots.length > 0 ? snapshots[0] : null;
let currentPrices = {};

// 최신 스냅샷에서 현재가와 시가총액 추출
let currentMarketCaps = {};
if (latestSnapshot) {
    console.log("스냅샷 파일:", latestSnapshot.file.path);
    const content = await app.vault.read(app.vault.getAbstractFileByPath(latestSnapshot.file.path));
    console.log("파일 내용 길이:", content.length);
    
    // 현재가 추출 (한국 주식: ₩, 미국 주식: $)
    const priceRegexKR = /\*\*종목코드\*\*:\s*(\d+)[\s\S]*?\*\*현재가\*\*:\s*₩([\d,]+)/g;
    const priceRegexUS = /\*\*종목코드\*\*:\s*([A-Z]+)[\s\S]*?\*\*현재가\*\*:\s*\$([\d,.]+)/g;
    
    let match;
    
    // 한국 주식 추출
    while ((match = priceRegexKR.exec(content)) !== null) {
        const ticker = match[1];
        const price = parseInt(match[2].replace(/,/g, ''));
        currentPrices[ticker] = price;
        console.log(`추출 (KR): ${ticker} = ₩${price}`);
    }
    
    // 미국 주식 추출
    while ((match = priceRegexUS.exec(content)) !== null) {
        const ticker = match[1];
        const price = parseFloat(match[2].replace(/,/g, ''));
        currentPrices[ticker] = price;
        console.log(`추출 (US): ${ticker} = $${price}`);
    }
    
    // 시가총액 추출
    const marketCapRegex = /\*\*종목코드\*\*:\s*([A-Z0-9]+)[\s\S]*?\*\*시가총액\*\*:\s*([^\n]+)/g;
    while ((match = marketCapRegex.exec(content)) !== null) {
        const ticker = match[1];
        const marketCap = match[2].trim();
        currentMarketCaps[ticker] = marketCap;
        console.log(`시총: ${ticker} = ${marketCap}`);
    }
    
    console.log("전체 추출된 데이터:", {prices: currentPrices, marketCaps: currentMarketCaps});
}

// 기업 분석 페이지들 (templates 폴더 제외)
const companies = dv.pages('#기업분석')
    .where(p => !p.file.path.includes('templates'))
    .sort(p => p.ticker);

// 테이블 헤더
const headers = ["기업명", "종목코드", "현재가", "현재시총", "목표시총", "목표시점", "상승여력"];

// 테이블 데이터 생성
const tableData = companies.map(company => {
    const ticker = company.ticker || "N/A";
    const currentPrice = currentPrices[ticker];
    const targetMarketCap = company.목표시가총액;
    const targetYear = company.목표시점;
    const market = company.market || "KQ"; // 기본값 코스닥
    
    // 상승여력 계산
    let upside = "N/A";
    
    const currentMarketCapStr = currentMarketCaps[ticker];
    
    if (targetMarketCap && currentMarketCapStr && currentMarketCapStr !== "N/A") {
        // 목표 시가총액을 조 단위로 변환
        let targetTrillionWon = 0;
        const targetStr = targetMarketCap.toString();
        
        if (targetStr.includes("조")) {
            const targetMatch = targetStr.match(/(\d+(?:\.\d+)?)\s*조/);
            if (targetMatch) targetTrillionWon = parseFloat(targetMatch[1]);
        } else if (targetStr.includes("천억")) {
            const targetMatch = targetStr.match(/(\d+)\s*천억/);
            if (targetMatch) targetTrillionWon = parseFloat(targetMatch[1]) / 10;
        } else if (targetStr.includes("억")) {
            const targetMatch = targetStr.match(/(\d+)\s*억/);
            if (targetMatch) targetTrillionWon = parseFloat(targetMatch[1]) / 10000;
        }
        
        // 현재 시가총액을 조 단위로 변환
        let currentTrillionWon = 0;
        if (currentMarketCapStr.includes("조")) {
            const currentMatch = currentMarketCapStr.match(/(\d+(?:\.\d+)?)\s*조/);
            if (currentMatch) currentTrillionWon = parseFloat(currentMatch[1]);
        } else if (currentMarketCapStr.includes("천억")) {
            const currentMatch = currentMarketCapStr.match(/(\d+)\s*천억/);
            if (currentMatch) currentTrillionWon = parseFloat(currentMatch[1]) / 10;
        } else if (currentMarketCapStr.includes("억")) {
            const currentMatch = currentMarketCapStr.match(/(\d+)\s*억/);
            if (currentMatch) currentTrillionWon = parseFloat(currentMatch[1]) / 10000;
        }
        
        if (targetTrillionWon > 0 && currentTrillionWon > 0) {
            upside = ((targetTrillionWon / currentTrillionWon - 1) * 100).toFixed(0);
            
            if (parseFloat(upside) > 0) {
                upside = "+" + upside + "% 📈";
            } else if (parseFloat(upside) < 0) {
                upside = upside + "% 📉";
            } else {
                upside = "0% ➖";
            }
        }
    }
    
    // 환율 설정 (달러당 원)
    const exchangeRate = 1330;
    
    // 현재가 포맷팅 (통화별)
    let formattedPrice = "N/A";
    if (currentPrice) {
        if (market === "US") {
            // 미국 주식: 달러 + 원화 병기
            const dollarPrice = currentPrice < 10 ? currentPrice.toFixed(2) : currentPrice.toLocaleString();
            const wonPrice = Math.round(currentPrice * exchangeRate).toLocaleString();
            formattedPrice = `$${dollarPrice} (₩${wonPrice})`;
        } else {
            // 한국 주식: 원으로 표시
            formattedPrice = "₩" + Math.round(currentPrice).toLocaleString();
        }
    }
    
    return [
        company.file.name.replace(".md", ""),
        ticker,
        formattedPrice,
        currentMarketCapStr || "N/A",
        targetMarketCap || "N/A",
        targetYear || "N/A",
        upside
    ];
});

// 테이블 렌더링
dv.table(headers, tableData);

// 마지막 업데이트 시간 표시 및 디버깅 정보
if (latestSnapshot) {
    dv.paragraph(`📅 주가 업데이트: ${latestSnapshot.created}`);
    dv.paragraph(`💾 스냅샷 파일: ${latestSnapshot.file.name}`);
    dv.paragraph(`🔍 추출된 주가: ${Object.keys(currentPrices).length}개 종목`);
}
```

## 📅 스냅샷 히스토리

```dataview
TABLE WITHOUT ID
  file.link AS "스냅샷",
  created AS "생성시각"
FROM "0. 대시보드/주가스냅샷"
WHERE type = "stock-snapshot"
SORT created DESC
LIMIT 10
```

## 🚀 주가 스냅샷 생성

### Shell Commands 플러그인으로 실행
1. **명령 팔레트** (Cmd+P) 열기
2. **"Shell commands: 📊 주가 스냅샷 생성"** 실행
3. 또는 설정한 **단축키** 사용

### 설정 방법
- [[주가 스냅샷 설정 가이드]] 참고

## 📝 메모
- 주가 데이터: Yahoo Finance API 실시간 조회
- 한국 주식: .KS(코스피), .KQ(코스닥)
- 스냅샷 저장: `0. 대시보드/주가스냅샷/`
- 상승여력: 목표 밸류에이션 대비 현재 시가총액 계산